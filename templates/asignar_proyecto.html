<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Persona - {{ proyecto.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Comsulting Admin</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/personas">Personas</a>
                <a class="nav-link" href="/clientes">Clientes</a>
                <a class="nav-link active" href="/proyectos">Proyectos</a>
                <a class="nav-link" href="/horas">Horas</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <h2 class="mb-4">Asignar Persona al Proyecto</h2>

                <div class="alert alert-info">
                    <strong>Proyecto:</strong> {{ proyecto.nombre }} ({{ proyecto.codigo }})<br>
                    <strong>Cliente:</strong> {{ proyecto.cliente.nombre }}
                </div>

                <form method="POST" action="/proyectos/{{ proyecto.id }}/asignar">
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Persona *</label>
                                <select name="persona_id" id="personaSelect" class="form-select" required>
                                    <option value="">Seleccionar persona...</option>
                                    {% for persona in personas %}
                                    <option value="{{ persona.id }}"
                                            data-cargo="{{ persona.cargo }}"
                                            data-costo="{{ persona.costo_hora }}">
                                        {{ persona.nombre }} - {{ persona.cargo }} ({{ "%.2f"|format(persona.costo_hora) }} UF/h)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Rol en el Proyecto *</label>
                                    <select name="rol_proyecto" id="rolSelect" class="form-select" required>
                                        <option value="">Seleccionar rol...</option>
                                        <option value="lider">Líder</option>
                                        <option value="colaborador" selected>Colaborador</option>
                                        <option value="soporte">Soporte</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Horas Estimadas</label>
                                    <input type="number" step="0.5" name="horas_estimadas" class="form-control"
                                           placeholder="0.0">
                                    <small class="text-muted">Horas totales estimadas en el proyecto</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Costo/Hora Proyecto (UF)</label>
                                    <input type="number" step="0.01" name="costo_hora_proyecto" id="costoHora"
                                           class="form-control" placeholder="Se usará el costo estándar">
                                    <small class="text-muted">Dejar vacío para usar costo estándar de la persona</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" name="fecha_inicio" class="form-control"
                                           value="{{ today }}">
                                </div>
                            </div>

                            <div class="alert alert-warning" id="capacidadAlert" style="display: none;">
                                <strong>⚠️ Advertencia:</strong> <span id="capacidadMensaje"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Asignar Persona</button>
                        <a href="/proyectos/{{ proyecto.id }}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-completar costo/hora cuando se selecciona persona
        document.getElementById('personaSelect').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            const costo = selected.getAttribute('data-costo');
            const cargo = selected.getAttribute('data-cargo');

            if (costo) {
                document.getElementById('costoHora').placeholder = `Estándar: ${costo} UF/h`;
            }

            // Sugerir rol según cargo
            const rolSelect = document.getElementById('rolSelect');
            if (cargo && (cargo.includes('Socio') || cargo.includes('Director'))) {
                rolSelect.value = 'lider';
            } else {
                rolSelect.value = 'colaborador';
            }
        });

        // Validación de capacidad (simulada - en producción consultar API)
        document.getElementById('personaSelect').addEventListener('change', async function() {
            const personaId = this.value;
            if (!personaId) return;

            // Aquí se podría hacer una llamada AJAX para verificar capacidad
            // Por ahora solo mostramos un mensaje informativo
            const alert = document.getElementById('capacidadAlert');
            const mensaje = document.getElementById('capacidadMensaje');

            // Ejemplo de validación
            mensaje.textContent = 'Recuerda verificar la capacidad disponible de la persona antes de asignar.';
            alert.style.display = 'block';
        });
    </script>
</body>
</html>
