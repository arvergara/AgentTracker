<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Rentabilidad por √Årea</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .back-link { color: #667eea; text-decoration: none; font-weight: 500; }
        .back-link:hover { text-decoration: underline; }

        /* Filtros */
        .filtros { display: flex; gap: 20px; align-items: center; margin: 20px 0; }
        .filtros label { font-weight: 500; color: #333; }
        .filtros select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .filtros button { padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .filtros button:hover { background: #5568d3; }

        /* Stats cards */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat { padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; }
        .stat h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .stat .value { font-size: 32px; font-weight: 700; }

        .section-title { font-size: 20px; color: #333; margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

        /* Tabla de √°reas */
        .area-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .area-table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 13px; font-weight: 600; }
        .area-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .area-row { cursor: pointer; transition: background 0.2s; }
        .area-row:hover { background: #f8f9fa; }
        .area-row.expandido { background: #eff6ff; }
        .expandir-icon { font-size: 12px; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        .expandir-icon.expandido { transform: rotate(90deg); }

        /* Detalle de √°rea (oculto por defecto) */
        .detalle-row { display: none; background: #f8f9fa; }
        .detalle-row.visible { display: table-row; }
        .detalle-container { padding: 20px 50px; }

        .detalle-section { margin-bottom: 20px; }
        .detalle-section h4 { font-size: 16px; color: #667eea; margin-bottom: 10px; }

        .lista-items { display: grid; gap: 8px; }
        .item { background: white; padding: 10px 15px; border-radius: 4px; border-left: 3px solid #667eea; display: flex; justify-content: space-between; align-items: center; }
        .item .nombre { font-weight: 500; color: #333; }
        .item .valor { text-align: right; font-size: 14px; color: #666; }

        .margen-positivo { color: #10b981; font-weight: 600; }
        .margen-negativo { color: #ef4444; font-weight: 600; }
        .margen-cero { color: #666; }

        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="navbar"><h1>üéØ AgentTracker - Rentabilidad por √Årea</h1></div>

    <div class="container">
        <div class="card">
            <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Volver al Dashboard</a>
            <h2 style="margin: 20px 0;">An√°lisis de Rentabilidad por √Årea</h2>

            <div class="filtros">
                <div>
                    <label for="a√±o">A√±o:</label>
                    <select id="a√±o">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                <div>
                    <label for="mes">Mes:</label>
                    <select id="mes">
                        <option value="">Todo el a√±o</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <button onclick="cargarDatos()">Actualizar</button>
            </div>

            <div id="stats-container" class="stats">
                <!-- Stats se cargan din√°micamente -->
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">üìä An√°lisis por √Årea</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Haz clic en cada √°rea para ver clientes y personas que trabajaron en ella</p>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Cargando datos...</p>
            </div>

            <table class="area-table" id="tabla-areas" style="display: none;">
                <thead>
                    <tr>
                        <th>√Årea</th>
                        <th style="text-align: right;">Ingresos (UF)</th>
                        <th style="text-align: right;">Horas</th>
                        <th style="text-align: right;">Costos Directos (UF)</th>
                        <th style="text-align: right;">Overhead (UF)</th>
                        <th style="text-align: right;">Total Costos (UF)</th>
                        <th style="text-align: right;">Margen (UF)</th>
                        <th style="text-align: right;">Margen %</th>
                    </tr>
                </thead>
                <tbody id="tbody-areas">
                    <!-- Filas se cargan din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let areasData = [];

        function formatoNumero(valor, decimales = 1) {
            if (!valor && valor !== 0) return '0,0';
            const num = parseFloat(valor);
            return num.toLocaleString('es-CL', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        function cargarDatos() {
            const a√±o = document.getElementById('a√±o').value;
            const mes = document.getElementById('mes').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('tabla-areas').style.display = 'none';

            let url = `/api/rentabilidad-por-area?a√±o=${a√±o}`;
            if (mes) url += `&mes=${mes}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    areasData = data;
                    mostrarStats(data);
                    mostrarTabla(data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('tabla-areas').style.display = 'table';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error al cargar los datos</p>';
                });
        }

        function mostrarStats(data) {
            const totalIngresos = data.reduce((sum, a) => sum + a.ingresos_uf, 0);
            const totalCostosDirectos = data.reduce((sum, a) => sum + (a.costos_directos_uf || 0), 0);
            const totalOverhead = data.reduce((sum, a) => sum + (a.overhead_uf || 0), 0);
            const totalCostos = data.reduce((sum, a) => sum + a.costos_uf, 0);
            const totalMargen = totalIngresos - totalCostos;
            const margenPorcentaje = totalIngresos > 0 ? (totalMargen / totalIngresos * 100) : 0;

            const statsHTML = `
                <div class="stat">
                    <h3>INGRESOS TOTALES</h3>
                    <div class="value">${formatoNumero(totalIngresos)} UF</div>
                </div>
                <div class="stat" style="background: linear-gradient(135deg, #3b82f6, #2563eb)">
                    <h3>COSTOS DIRECTOS</h3>
                    <div class="value">${formatoNumero(totalCostosDirectos)} UF</div>
                </div>
                <div class="stat" style="background: linear-gradient(135deg, #f59e0b, #d97706)">
                    <h3>OVERHEAD</h3>
                    <div class="value">${formatoNumero(totalOverhead)} UF</div>
                </div>
                <div class="stat">
                    <h3>COSTOS TOTALES</h3>
                    <div class="value">${formatoNumero(totalCostos)} UF</div>
                </div>
                <div class="stat" style="background: ${totalMargen > 0 ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}">
                    <h3>MARGEN</h3>
                    <div class="value">${formatoNumero(totalMargen)} UF</div>
                    <p style="font-size: 18px; margin-top: 5px;">${formatoNumero(margenPorcentaje)}%</p>
                </div>
            `;

            document.getElementById('stats-container').innerHTML = statsHTML;
        }

        function mostrarTabla(data) {
            const tbody = document.getElementById('tbody-areas');
            let html = '';

            data.forEach((area, index) => {
                const margenClass = area.margen > 0 ? 'margen-positivo' : (area.margen < 0 ? 'margen-negativo' : 'margen-cero');

                html += `
                    <tr class="area-row" onclick="toggleDetalle(${index})" id="row-${index}">
                        <td>
                            <span class="expandir-icon" id="icon-${index}">‚ñ∂</span>
                            <strong>${area.area}</strong>
                        </td>
                        <td style="text-align: right;">${formatoNumero(area.ingresos_uf)}</td>
                        <td style="text-align: right;">${formatoNumero(area.horas)}</td>
                        <td style="text-align: right;">${formatoNumero(area.costos_directos_uf || 0)}</td>
                        <td style="text-align: right; color: #f59e0b;">${formatoNumero(area.overhead_uf || 0)}</td>
                        <td style="text-align: right; font-weight: 600;">${formatoNumero(area.costos_uf)}</td>
                        <td style="text-align: right;" class="${margenClass}">${formatoNumero(area.utilidad_uf)}</td>
                        <td style="text-align: right;" class="${margenClass}">${formatoNumero(area.margen)}%</td>
                    </tr>
                    <tr class="detalle-row" id="detalle-${index}">
                        <td colspan="8">
                            <div class="detalle-container">
                                ${generarDetalle(area)}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function generarDetalle(area) {
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">';

            // Clientes
            html += '<div class="detalle-section">';
            html += '<h4>üè¢ Clientes (' + (area.clientes?.length || 0) + ')</h4>';
            html += '<div class="lista-items">';

            if (area.clientes && area.clientes.length > 0) {
                area.clientes.forEach(cliente => {
                    html += `
                        <div class="item">
                            <span class="nombre">${cliente.nombre}</span>
                            <span class="valor">${formatoNumero(cliente.horas)} horas</span>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #666; font-style: italic;">Sin clientes en este per√≠odo</p>';
            }

            html += '</div></div>';

            // Personas
            html += '<div class="detalle-section">';
            html += '<h4>üë• Personas (' + (area.personas?.length || 0) + ')</h4>';
            html += '<div class="lista-items">';

            if (area.personas && area.personas.length > 0) {
                area.personas.forEach(persona => {
                    html += `
                        <div class="item">
                            <span class="nombre">${persona.nombre}</span>
                            <span class="valor">${formatoNumero(persona.horas)} horas ¬∑ ${formatoNumero(persona.costo_uf)} UF</span>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #666; font-style: italic;">Sin personas en este per√≠odo</p>';
            }

            html += '</div></div>';
            html += '</div>';

            return html;
        }

        function toggleDetalle(index) {
            const row = document.getElementById(`row-${index}`);
            const detalle = document.getElementById(`detalle-${index}`);
            const icon = document.getElementById(`icon-${index}`);

            if (detalle.classList.contains('visible')) {
                detalle.classList.remove('visible');
                row.classList.remove('expandido');
                icon.classList.remove('expandido');
            } else {
                detalle.classList.add('visible');
                row.classList.add('expandido');
                icon.classList.add('expandido');
            }
        }

        // Cargar datos al inicio
        cargarDatos();
    </script>
</body>
</html>
