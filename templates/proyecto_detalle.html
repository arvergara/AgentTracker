<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ proyecto.nombre }} - Comsulting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Comsulting Admin</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/personas">Personas</a>
                <a class="nav-link" href="/clientes">Clientes</a>
                <a class="nav-link active" href="/proyectos">Proyectos</a>
                <a class="nav-link" href="/horas">Horas</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>{{ proyecto.nombre }}</h1>
                <p class="text-muted mb-0">{{ proyecto.codigo }} | Cliente: {{ proyecto.cliente.nombre }}</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <a href="/proyectos/{{ proyecto.id }}/editar" class="btn btn-warning">‚úèÔ∏è Editar Proyecto</a>
                {% if proyecto.estado == 'activo' %}
                    <span class="badge bg-success fs-6">Activo</span>
                {% elif proyecto.estado == 'pausado' %}
                    <span class="badge bg-warning fs-6">Pausado</span>
                {% elif proyecto.estado == 'cerrado' %}
                    <span class="badge bg-secondary fs-6">Cerrado</span>
                {% else %}
                    <span class="badge bg-info fs-6">{{ proyecto.estado|title }}</span>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Informaci√≥n del Proyecto -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informaci√≥n del Proyecto</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Tipo:</strong> {{ proyecto.tipo|title if proyecto.tipo else 'N/A' }}</p>
                        <p><strong>Fecha Inicio:</strong> {{ proyecto.fecha_inicio.strftime('%d/%m/%Y') if proyecto.fecha_inicio else 'N/A' }}</p>
                        <p><strong>Fecha Fin:</strong> {{ proyecto.fecha_fin.strftime('%d/%m/%Y') if proyecto.fecha_fin else 'N/A' }}</p>
                        <p><strong>Presupuesto:</strong> {{ "%.2f UF"|format(proyecto.presupuesto_uf) if proyecto.presupuesto_uf else 'N/A' }}</p>
                        <p><strong>Margen Objetivo:</strong> {{ "%.1f%%"|format(proyecto.margen_objetivo) if proyecto.margen_objetivo else '12.5%' }}</p>
                        {% if proyecto.descripcion %}
                        <hr>
                        <p class="text-muted"><small>{{ proyecto.descripcion }}</small></p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Rentabilidad -->
            <div class="col-md-8">
                {% if rentabilidad %}
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Rentabilidad del Proyecto</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <h6 class="text-muted">Ingresos</h6>
                                <h4>{{ "%.2f"|format(rentabilidad.ingresos_uf) }} UF</h4>
                                <small class="text-muted">${{ "{:,}".format(rentabilidad.ingresos_pesos|int) }}</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-muted">Costos</h6>
                                <h4>{{ "%.2f"|format(rentabilidad.costos_uf) }} UF</h4>
                                <small class="text-muted">${{ "{:,}".format(rentabilidad.costos_pesos|int) }}</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-muted">Margen</h6>
                                <h4 class="{% if rentabilidad.margen >= rentabilidad.margen_objetivo %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.1f"|format(rentabilidad.margen) }}%
                                </h4>
                                <small class="text-muted">Objetivo: {{ "%.1f"|format(rentabilidad.margen_objetivo) }}%</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-muted">ROI</h6>
                                <h4>{{ "%.1f"|format(rentabilidad.roi) }}%</h4>
                                <small class="text-muted">{{ rentabilidad.estado_rentabilidad|title }}</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Utilidad Bruta</h6>
                                <p class="mb-0">{{ "%.2f"|format(rentabilidad.utilidad_bruta_uf) }} UF
                                    <small class="text-muted">({{ "{:,}".format(rentabilidad.utilidad_bruta_pesos|int) }} CLP)</small>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Utilidad Neta</h6>
                                <p class="mb-0">{{ "%.2f"|format(rentabilidad.utilidad_neta_uf) }} UF
                                    <small class="text-muted">({{ "{:,}".format(rentabilidad.utilidad_neta_pesos|int) }} CLP)</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Equipo Asignado -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Equipo del Proyecto</h5>
                        <a href="/proyectos/{{ proyecto.id }}/asignar" class="btn btn-light btn-sm">+ Asignar Persona</a>
                    </div>
                    <div class="card-body">
                        {% if asignaciones %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Persona</th>
                                        <th>Cargo</th>
                                        <th>Rol en Proyecto</th>
                                        <th>Horas Estimadas</th>
                                        <th>Costo/Hora (UF)</th>
                                        <th>Fecha Asignaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for asignacion in asignaciones %}
                                    <tr>
                                        <td><strong>{{ asignacion.persona.nombre }}</strong></td>
                                        <td>{{ asignacion.persona.cargo }}</td>
                                        <td>
                                            {% if asignacion.rol_proyecto == 'lider' %}
                                                <span class="badge bg-primary">L√≠der</span>
                                            {% elif asignacion.rol_proyecto == 'colaborador' %}
                                                <span class="badge bg-info">Colaborador</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ asignacion.rol_proyecto|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ "%.1f"|format(asignacion.horas_estimadas) if asignacion.horas_estimadas else 'N/A' }}</td>
                                        <td>{{ "%.2f"|format(asignacion.costo_hora_proyecto) if asignacion.costo_hora_proyecto else "%.2f"|format(asignacion.persona.costo_hora) }}</td>
                                        <td>{{ asignacion.fecha_inicio.strftime('%d/%m/%Y') if asignacion.fecha_inicio else 'N/A' }}</td>
                                        <td>
                                            <form method="POST" action="/proyectos/{{ proyecto.id }}/asignaciones/{{ asignacion.id }}/eliminar" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¬øDesasignar a {{ asignacion.persona.nombre }} del proyecto?')">
                                                    üóëÔ∏è
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-4">No hay personas asignadas a este proyecto a√∫n.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Desglose por Persona (si hay rentabilidad) -->
        {% if rentabilidad and rentabilidad.equipo %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Distribuci√≥n de Horas por Persona</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Persona</th>
                                        <th>Cargo</th>
                                        <th>Horas Trabajadas</th>
                                        <th>% Participaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for persona in rentabilidad.equipo %}
                                    <tr>
                                        <td>{{ persona.persona }}</td>
                                        <td>{{ persona.cargo }}</td>
                                        <td>{{ "%.1f"|format(persona.horas) }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ persona.porcentaje }}%"
                                                     aria-valuenow="{{ persona.porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ "%.1f"|format(persona.porcentaje) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mt-4 mb-4">
            <a href="/proyectos" class="btn btn-secondary">‚Üê Volver a Proyectos</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
